#!/bin/bash

# RAGFlow MVP - One-Command Startup Script
# This script starts the entire RAGFlow MVP system with full automation

set -e

echo "ğŸš€ Starting RAGFlow MVP - Email Intelligence System for IVC"
echo "========================================================"

# Check if Docker and Docker Compose are installed
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is not installed. Please install Docker first."
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose is not installed. Please install Docker Compose first."
    exit 1
fi

# Create necessary directories
echo "ğŸ“ Creating necessary directories..."
mkdir -p config
mkdir -p backend/data
mkdir -p backend/logs

# Check if .env file exists, create a basic one if not
if [ ! -f .env ]; then
    echo "ğŸ“ Creating basic .env file..."
    cat > .env << EOF
# RAGFlow MVP Environment Configuration
# Auto-generated by start.sh

# Database
POSTGRES_DB=ragflow_db
POSTGRES_USER=ragflow
POSTGRES_PASSWORD=ragflow123

# Google OAuth (IVC Company)
GOOGLE_CLIENT_ID=792999098406-hmolqmci0o9op9t2vpknmhespml53bau.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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
GOOGLE_PROJECT_ID=ivc-ragflow-project

# Google Drive Folders
GDRIVE_DOCUMENTS_FOLDER_ID=1oas1TEtW26ZNvW2jekk6Y8R2Hb85IUmn
GDRIVE_ATTACHMENTS_FOLDER_ID=1dEjEogfE3WlHypaY8vuaWiBeZjjuVTGV

# LLM Configuration
LLM_MODEL=mistral:7b-instral-v0.3-q4_K_M
LLM_TEMPERATURE=0.3

# System
LOG_LEVEL=INFO
OCR_ENABLED=true
MAX_CONCURRENT_PROCESSES=4

# Security (CHANGE THESE IN PRODUCTION!)
SECRET_KEY=ragflow-secret-key-change-in-production
TOKEN_ENCRYPTION_KEY=ragflow-encryption-key-32-chars-123
EOF
    echo "âœ… Created .env file with default configuration"
fi

# Stop any existing containers
echo "ğŸ›‘ Stopping any existing RAGFlow containers..."
docker-compose down --remove-orphans || true

# Clean up any orphaned containers
echo "ğŸ§¹ Cleaning up orphaned containers..."
docker container prune -f || true

# Pull latest images
echo "ğŸ“¥ Pulling latest Docker images..."
docker-compose pull

# Build custom images
echo "ğŸ”¨ Building custom Docker images..."
docker-compose build

# Start the system with initialization
echo "ğŸš€ Starting RAGFlow MVP system..."
docker-compose up -d

# Wait for initialization to complete
echo "â³ Waiting for system initialization..."
echo "This may take 5-10 minutes for the first run (downloading models, setting up database)..."

# Monitor the init container
docker-compose logs -f init &
LOGS_PID=$!

# Wait for init container to complete
while [ "$(docker-compose ps -q init)" ]; do
    sleep 10
done

# Stop the logs monitoring
kill $LOGS_PID 2>/dev/null || true

# Show final status
echo ""
echo "ğŸ‰ RAGFlow MVP System Status"
echo "========================="

# Check service health
services=("postgres" "redis" "ragflow" "ollama" "backend" "frontend")
all_healthy=true

for service in "${services[@]}"; do
    if docker-compose ps | grep -q "${service}.*Up.*healthy"; then
        echo "âœ… $service: Running and Healthy"
    elif docker-compose ps | grep -q "${service}.*Up"; then
        echo "âš ï¸  $service: Running (health check pending)"
    else
        echo "âŒ $service: Not Running"
        all_healthy=false
    fi
done

echo ""
if [ "$all_healthy" = true ]; then
    echo "ğŸŠ SUCCESS! Your RAGFlow MVP is ready to go!"
    echo ""
    echo "ğŸ“± Access your system:"
    echo "   ğŸŒ Frontend (Web UI):     http://localhost:3000"
    echo "   ğŸ”§ Backend API:           http://localhost:8000"
    echo "   ğŸ“Š RAGFlow:               http://localhost:9380"
    echo "   ğŸ¤– Ollama:                http://localhost:11434"
    echo "   ğŸ—„ï¸  PostgreSQL:           localhost:5432"
    echo "   ğŸ“¦ Redis:                 localhost:6379"
    echo ""
    echo "ğŸ¯ Quick Start:"
    echo "   1. Open http://localhost:3000 in your browser"
    echo "   2. Go to the Authentication tab ğŸ”"
    echo "   3. The first Gmail (storesnproduction@ivc-valves.com) should auto-authenticate"
    echo "   4. Use 'Auto-Authenticate All' for other Gmail accounts"
    echo "   5. Start processing emails and enjoy your AI email intelligence!"
    echo ""
    echo "ğŸ“§ Configured Email Sequence:"
    echo "   1. storesnproduction@ivc-valves.com (auto-auth)"
    echo "   2. hr.ivcvalves@gmail.com"
    echo "   3. umesh.jadhav@ivc-valves.com"
    echo "   4. arpatil@ivc-valves.com"
    echo "   5. exports@ivc-valves.com"
    echo "   6. sumit.basu@ivc-valves.com"
    echo "   7. hr@ivc-valves.com"
    echo ""
else
    echo "âš ï¸  Some services are not healthy. Check the logs with:"
    echo "   docker-compose logs [service-name]"
    echo ""
    echo "ğŸ”§ Troubleshooting commands:"
    echo "   docker-compose ps              # Check service status"
    echo "   docker-compose logs backend    # Check backend logs"
    echo "   docker-compose logs ollama     # Check Ollama logs"
    echo "   docker-compose restart         # Restart all services"
fi

echo ""
echo "ğŸ› ï¸  Management Commands:"
echo "   docker-compose logs -f         # View live logs"
echo "   docker-compose stop            # Stop all services"
echo "   docker-compose restart         # Restart all services"
echo "   docker-compose down            # Stop and remove containers"
echo "   ./start.sh                     # Run this script again"
echo ""
echo "ğŸ“– For detailed documentation, see: SYSTEM_OVERVIEW.md"
echo "ğŸ†˜ For support, check the logs and troubleshooting guide" 